{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    .ooo {
        padding-bottom: 15px;
    }

    .article-description * ul {
        padding-left: 20px;
    }
</style>

<!-- ======= Font Awesome ======= -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<div
    class="w-full h-full flex flex-col md:flex-row lg:flex-row flex-nowrap justify-between items-center md:justify-start md:items-start lg:justify-start lg:items-start overflow-hidden box-border">
    {% include 'left_menu.html' %}
    <div
        class="w-full h-full flex flex-col justify-between items-start  bg-[#F4F4F4] gap-5 box-border order-1 md:order-2 lg:order-2 xl:order-2 2xl-order-2 relative ooo">
        <div
            class="min-w-[280px] w-full 2xl:container h-full flex flex-col justify-start items-start p-3 gap-5 scrollbar-none box-border overflow-scroll scroll-smooth">
            <div
                class="w-full h-max flex flex-col justify-start items-start gap-y-5 overflow-y-scroll scrollbar-none md:p-10 lg:p-10">
                <div
                    class="w-full max-w-full h-fit rounded-3xl p-5 flex flex-col justify-center items-start gap-y-8 bg-white article-description">
                    <img alt="post image" loading="eager" width="930" height="610" decoding="async" data-nimg="1"
                        class="w-full h-auto object-cover rounded-3xl" src="{{ article.image.url }}"
                        style="color: transparent;">
                    <div class="w-full flex flex-row justify-between items-start">	
                        <div class="w-full h-max flex flex-row justify-start items-center gap-3 flex-nowrap"><img
                                alt="user image" loading="eager" width="64" height="64" decoding="async" data-nimg="1"
                                class="w-16 h-16 object-cover rounded-full"
                                src="{% if article.author.profile_image %}{{ article.author.profile_image.url }}{% else %}{{ article.author.first_name }}{% endif %}">
                            <div class="max flex flex-col justify-start items-start">
                                <h1 class="text-base md:text-lg lg:text-xl font-semibold">{{ article.author.first_name }}</h1>
                                <p class="text-sm md:text-md lg:text-lg font-normal text-gray-500">Muallif</p>
                            </div>
                        </div>
                        <section class="w-max text-sm text-gray-500 flex flex-row gap-3"><span
                                class="w-max flex flex-row justify-center items-center gap-x-1 group "><svg
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor" aria-hidden="true" width="14" class="cursor-pointer">
                                    <title>Sana</title>
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z">
                                    </path>
                                </svg>
                                <p>{{ article.time }}</p>
                            </span><span class="w-max flex flex-row justify-center items-center gap-x-1 group "><svg
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor" aria-hidden="true" width="14" class="cursor-pointer">
                                    <title>Ko`rish soni</title>
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>{{ article.views.count }}</span></section>
                    </div>
                    <h1 class="text-lg md:text-xl lg:text-3xl font-semibold w-full text-left">{{ article.title }}</h1>
                    <div class="flex flex-row flex-nowrap justify-start items-start gap-2.5 mb-2"><span
                            class="rounded-md py px-3 text-sm md:text-md lg:text-lg text-gray-500">{{ article.category.title }}</span></div>
                    <div class="w-full h-max">
                        <p>{{ article.summary }}</p>
                    </div>
                    {{ article.body|safe }}
                    <section class="mt-3 flex flex-row justify-start items-center gap-x-4">
                        <div class="flex items-center">
                            <a href="{% url 'article_detail' article.id %}?rate=1" type="button" class="w-max h-max">
                                <span
                                    class="rate-span w-5 h-5 opacity-20 cursor-pointer hover:text-yellow-500">ðŸ™‚</span>
                            </a>
                            <a href="{% url 'article_detail' article.id %}?rate=2" type="button" class="w-max h-max">
                                <span
                                    class="rate-span w-5 h-5 opacity-20 cursor-pointer hover:text-yellow-500">ðŸ™‚</span>
                            </a>
                            <a href="{% url 'article_detail' article.id %}?rate=3" type="button" class="w-max h-max">
                                <span
                                    class="rate-span w-5 h-5 opacity-20 cursor-pointer hover:text-yellow-500">ðŸ™‚</span>
                            </a>
                            <a href="{% url 'article_detail' article.id %}?rate=4" type="button" class="w-max h-max">
                                <span
                                    class="rate-span w-5 h-5 opacity-20 cursor-pointer hover:text-yellow-500">ðŸ™‚</span>
                            </a>
                            <a href="{% url 'article_detail' article.id %}?rate=5" type="button" class="w-max h-max">
                                <span
                                    class="rate-span w-5 h-5 opacity-20 cursor-pointer hover:text-yellow-500">ðŸ™‚</span>
                            </a>
                            <p class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">{{ mean_rate }}</p>
                        </div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                            aria-hidden="true" width="20" class="cursor-copy">
                            <title>Nusxa olish</title>
                            <path fill-rule="evenodd"
                                d="M19.902 4.098a3.75 3.75 0 00-5.304 0l-4.5 4.5a3.75 3.75 0 001.035 6.037.75.75 0 01-.646 1.353 5.25 5.25 0 01-1.449-8.45l4.5-4.5a5.25 5.25 0 117.424 7.424l-1.757 1.757a.75.75 0 11-1.06-1.06l1.757-1.757a3.75 3.75 0 000-5.304zm-7.389 4.267a.75.75 0 011-.353 5.25 5.25 0 011.449 8.45l-4.5 4.5a5.25 5.25 0 11-7.424-7.424l1.757-1.757a.75.75 0 111.06 1.06l-1.757 1.757a3.75 3.75 0 105.304 5.304l4.5-4.5a3.75 3.75 0 00-1.035-6.037.75.75 0 01-.354-1z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </section>
                    <script>
                        rate_spans = document.querySelectorAll('.rate-span')
                        for (let i = 0; i < "{{mean_rate}}"; i++) {
                            rate_spans[i].classList.remove('opacity-20')
                        }
                    </script>
                </div>
                <div class="w-full flex flex-col justify-start items-start my-4">
                    <form class="w-full flex flex-col justify-start items-center gap-4" method="post">
                        {% csrf_token %}
                        <h1 class="w-full text-left h-max text-base md:text-lg lg:text-xl font-semibold">Izohlar</h1>
                        <div class="w-full flex flex-row justify-start items-center bg-white gap-3 p-2 rounded-lg">
                            <textarea id="comment"
                                class="py-3 border w-full bg-white outline-none border-none px-5 disabled:cursor-not-allowed"
                                placeholder="Izoh qoldiring..." name="comment" required=""></textarea>
                            <button id="submitBtn" type="button"
                                class="py-3 px-5 rounded-xl bg-[#1D9DA0] text-white">
                                Yuborish
                            </button>
                
                            <div class="toast hidden">
                                <div class="toast-content">
                                    <i class="fas fa-solid fa-check check"></i>
                                    <div class="message">
                                        <span class="text text-1" id="fail-succ">Success</span>
                                        <span class="text text-2" id="message">Izoh muvaffaqiyatli yuborildi!</span>
                                    </div>
                                </div>
                                <i class="fa-solid fa-xmark close"></i>
                                <div class="progress"></div>
                            </div>
                        </div>
                    </form>
                
                    <style>
                        .toast {
                            position: absolute;
                            top: 25px;
                            right: 30px;
                            border-radius: 12px;
                            background: #fff;
                            padding: 20px 35px 20px 25px;
                            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
                            border-left: 6px solid #4070f4;
                            display: flex;
                            transform: translateX(calc(100% + 30px));
                            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.35);
                            overflow: hidden;
                        }
                
                        .toast.active {
                            transform: translateX(0%);
                        }
                
                        .toast .toast-content {
                            display: flex;
                            align-items: center;
                        }
                
                        .toast-content .check {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            height: 35px;
                            width: 35px;
                            background-color: #4070f4;
                            color: #fff;
                            font-size: 20px;
                            border-radius: 50%;
                        }
                
                        .toast-content .message {
                            display: flex;
                            flex-direction: column;
                            margin: 0 20px;
                        }
                
                        .message .text {
                            font-size: 20px;
                            font-weight: 400;
                            color: #666666;
                        }
                
                        .message .text.text-1 {
                            font-weight: 600;
                            color: #333;
                        }
                
                        .toast .close {
                            position: absolute;
                            top: 10px;
                            right: 15px;
                            padding: 5px;
                            cursor: pointer;
                            opacity: 0.7;
                        }
                
                        .toast .close:hover {
                            opacity: 1;
                        }
                
                        .toast .progress {
                            position: absolute;
                            bottom: 0;
                            left: 0;
                            height: 3px;
                            width: 100%;
                            background: #ddd;
                        }
                
                        .toast .progress::before {
                            content: '';
                            position: absolute;
                            bottom: 0;
                            right: 0;
                            height: 100%;
                            width: 100%;
                            background-color: #4070f4;
                        }
                
                        .progress.active::before {
                            animation: progress 10s linear forwards;
                        }
                
                        @keyframes progress {
                            100% {
                                right: 100%;
                            }
                        }

                        .toast * a {
                            text-decoration: underline;
                        }
                    </style>
                
                {% if user.is_authenticated %}
                <script>
                    window.addEventListener('load', function () {
                        const toast = document.querySelector(".toast");
                        const progress = document.querySelector(".progress");
                        const message = document.getElementById('message');
                
                        const storedMessage = localStorage.getItem('commentMessage');
                        const isSuccess = localStorage.getItem('isSuccess');

                        if (storedMessage && isSuccess) {
                            message.textContent = storedMessage;
                            toast.classList.add("active");
                            progress.classList.add("active");
                
                            setTimeout(() => {
                                toast.classList.remove("active");
                            }, 10000); // 10 soniya davomida ko'rsatish
                
                            localStorage.removeItem('commentMessage');
                            localStorage.removeItem('isSuccess');
                        }
                
                        document.getElementById('submitBtn').addEventListener('click', function () {
                            const isLoggedIn = `{{user_login}}`; 
                            // const isLoggedIn = true; 
                            const comment = document.getElementById('comment').value;
                
                            if (isLoggedIn) {
                                if (comment) {
                                    message.textContent = "Izoh muvaffaqiyatli yuborildi!";
                                    localStorage.setItem('commentMessage', message.textContent);
                                    localStorage.setItem('isSuccess', 'true');
                
                                    // Success ikonini ko'rsatish
                                    document.querySelector('.check').classList.remove('fa-xmark');
                                    document.querySelector('.check').classList.add('fa-check');
                
                                    // Formani yuborish
                                    document.querySelector('form').submit();
                                } else {
                                    message.textContent = "Iltimos, izoh qoldiring.";
                                    localStorage.setItem('commentMessage', message.textContent);
                                    localStorage.setItem('isSuccess', 'false');
                                    document.querySelector('#fail-succ').textContent = "Izoh qoldiring !"
                
                                    // Error ikonini ko'rsatish
                                    document.querySelector('.check').classList.remove('fa-check');
                                    document.querySelector('.check').classList.add('fa-circle-exclamation');
                                }
                            } else {
                                message.innerHTML = `Iltimos izoh qoldirish uchun <a class="register-link" href="{% url 'signup' %}">Ro'yxatdan o'ting</a> yoki <a class="register-link" href="{% url 'login' %}">Tizimga kiring</a>`;
                                localStorage.setItem('commentMessage', message.innerHTML);
                                localStorage.setItem('isSuccess', 'false');
                
                                // Error ikonini ko'rsatish
                                document.querySelector('.check').classList.remove('fa-check');
                                document.querySelector('.check').classList.add('fa-xmark');
                                document.querySelector('#fail-succ').textContent = "Xatolik ro'y berdi";
                            }
                
                            // Toastni ko'rsatish
                            toast.classList.add("active");
                            progress.classList.add("active");
                
                            setTimeout(() => {
                                toast.classList.remove("active");
                            }, 10000); // 10 soniya davomida ko'rsatish
                        });
                
                        // Toastni yopish tugmasi
                        document.querySelector(".close").addEventListener("click", () => {
                            toast.classList.remove("active");
                        });
                    });
                </script>
                {% else %}
                <script>
                    window.addEventListener('load', function () {
                        const toast = document.querySelector(".toast");
                        const progress = document.querySelector(".progress");
                        const message = document.getElementById('message');
                
                        const storedMessage = localStorage.getItem('commentMessage');
                        const isSuccess = localStorage.getItem('isSuccess');

                        if (storedMessage && isSuccess) {
                            message.textContent = storedMessage;
                            toast.classList.add("active");
                            progress.classList.add("active");
                
                            setTimeout(() => {
                                toast.classList.remove("active");
                            }, 10000); // 10 soniya davomida ko'rsatish
                
                            localStorage.removeItem('commentMessage');
                            localStorage.removeItem('isSuccess');
                        }
                
                        document.getElementById('submitBtn').addEventListener('click', function () {
                            // const isLoggedIn = `{{user_login}}`; 
                            const isLoggedIn = false; 
                            const comment = document.getElementById('comment').value;
                
                            if (isLoggedIn) {
                                if (comment) {
                                    message.textContent = "Izoh muvaffaqiyatli yuborildi!";
                                    localStorage.setItem('commentMessage', message.textContent);
                                    localStorage.setItem('isSuccess', 'true');
                
                                    // Success ikonini ko'rsatish
                                    document.querySelector('.check').classList.remove('fa-xmark');
                                    document.querySelector('.check').classList.add('fa-check');
                
                                    // Formani yuborish
                                    document.querySelector('form').submit();
                                } else {
                                    message.textContent = "Iltimos, izoh qoldiring.";
                                    localStorage.setItem('commentMessage', message.textContent);
                                    localStorage.setItem('isSuccess', 'false');
                                    document.querySelector('#fail-succ').textContent = "Izoh qoldiring !"
                
                                    // Error ikonini ko'rsatish
                                    document.querySelector('.check').classList.remove('fa-check');
                                    document.querySelector('.check').classList.add('fa-circle-exclamation');
                                }
                            } else {
                                message.innerHTML = `Iltimos izoh qoldirish uchun <a class="register-link" href="{% url 'signup' %}">Ro'yxatdan o'ting</a> yoki <a class="register-link" href="{% url 'login' %}">Tizimga kiring</a>`;
                                localStorage.setItem('commentMessage', message.innerHTML);
                                localStorage.setItem('isSuccess', 'false');
                
                                // Error ikonini ko'rsatish
                                document.querySelector('.check').classList.remove('fa-check');
                                document.querySelector('.check').classList.add('fa-xmark');
                                document.querySelector('#fail-succ').textContent = "Xato ro'y berdi";
                            }
                
                            // Toastni ko'rsatish
                            toast.classList.add("active");
                            progress.classList.add("active");
                
                            setTimeout(() => {
                                toast.classList.remove("active");
                            }, 10000); // 10 soniya davomida ko'rsatish
                        });
                
                        // Toastni yopish tugmasi
                        document.querySelector(".close").addEventListener("click", () => {
                            toast.classList.remove("active");
                        });
                    });
                </script>
                {% endif %}
                </div>
                
                
                <div class="w-full h-max flex flex-col justify-start items-start gap-10"></div>
                <div class="w-full h-max flex flex-col justify-start items-start gap-10">
                    {% for comment in article.comments.all %}
                    <div class="w-full flex flex-row justify-start items-start gap-3">
                        {% if comment.author.profile_image %}
                        <img alt="comment-image" loading="lazy" width="60" height="60" decoding="async" data-nimg="1"
                            class="w-20 h-20 border rounded-full" src="{{ comment.author.profile_image.url }}"
                            style="color: transparent;">
			{% endif %}
                        <section class="h-full flex flex-col justify-center items-start">
                            <h1 class="w-full text-base md:text-base lg:text-lg font-semibold">{{ comment.user.first_name }}  {{ comment.user }}</h1>
                            <p class="text-sm text-gray-500">{{ comment.time }}</p>
                            <p class="mt-3 text-lg">{{ comment.text }}</p>
                        </section>
                    </div>
                    {% endfor %}
                </div>
                <div style="border-top:1px solid #333;" class="w-full h-max flex flex-col justify-start items-start gap-10"></br>
			<h2 style="font-size:30px;"><b>O'xshash maqolalar</b></h2>
                    {% for r in related %}
                        <a style="color: blue;text-decoration: underline;" href="{% url 'article_detail' r.id %}">{{ r }}</a>
                    {% endfor %}
                </div>

            </div>
        </div>
        <section class="w-full hidden md:flex lg:flex justify-center items-center">
            {% include 'footer.html' %}
        </section>
    </div>
</div>
{% endblock content %}

